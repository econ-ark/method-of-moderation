#!/bin/bash
# Post-build script for Binder
# Single Source of Truth: pyproject.toml + uv.lock (dependencies)
#
# This script mirrors the setup from reproduce/docker/setup.sh but adapted for Binder's
# conda-based environment where we install into the system Python rather than a venv.

set -e

echo "üöÄ Setting up Method of Moderation Binder environment..."

# Binder clones the repo to the user's home directory
REPO_DIR="${HOME}"

# ============================================================================
# Install Node.js 18 (required by MyST for documentation)
# ============================================================================
echo "üì¶ Installing Node.js 18..."

# Use nodesource for Node.js 18 (matches Dockerfile and devcontainer)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo bash -
sudo apt-get install -y nodejs

echo "‚úì Node.js $(node --version)"
echo "‚úì npm $(npm --version)"

# ============================================================================
# Install uv package manager (pinned for reproducibility)
# ============================================================================
echo "üì¶ Installing uv..."

# Pin uv version for reproducible builds
# Update this version periodically to get bug fixes and new features
pip install "uv>=0.5,<1.0"

echo "‚úì uv $(uv --version)"

# ============================================================================
# Install dependencies from pyproject.toml using locked versions
# ============================================================================
echo "üêç Installing Python dependencies from pyproject.toml..."

cd "${REPO_DIR}"

# Export locked dependencies to requirements.txt format
# This respects [tool.uv.sources] and ensures reproducible builds
uv export --frozen --no-hashes --no-dev -o /tmp/requirements.txt

# Install the exported requirements into the system Python
uv pip install --system -r /tmp/requirements.txt

# Install the project itself in editable mode
uv pip install --system --no-deps -e .

rm /tmp/requirements.txt

# ============================================================================
# Configure environment
# ============================================================================
echo "‚öôÔ∏è Configuring environment..."

# Set PYTHONPATH to include code/ directory
# This is added to the kernel's environment
mkdir -p ~/.ipython/profile_default/startup
cat > ~/.ipython/profile_default/startup/00-pythonpath.py << 'PYEOF'
import os
import sys

# Add code/ directory to Python path (Binder clones to home directory)
repo_dir = os.environ.get('HOME', '/home/jovyan')
code_dir = os.path.join(repo_dir, 'code')
if os.path.isdir(code_dir) and code_dir not in sys.path:
    sys.path.insert(0, code_dir)
PYEOF

# Also set for shell sessions
# shellcheck disable=SC2016  # Single quotes are intentional - variables expand at runtime
echo 'export PYTHONPATH="${HOME}/code:${PYTHONPATH}"' >> ~/.bashrc

# ============================================================================
# Warm up caches (non-critical, failures are logged but don't stop the build)
# ============================================================================
echo "üî• Warming up caches..."

# Generate matplotlib font cache
if python -c "import matplotlib as mpl; mpl.use('Agg'); import pylab as plt; fig, ax = plt.subplots(); fig.savefig('/tmp/test.png')" 2>&1; then
    echo "‚úì Matplotlib font cache generated"
else
    echo "‚ö†Ô∏è Matplotlib cache warmup failed (non-critical, first plot may be slow)"
fi
rm -f /tmp/test.png

# Pre-compile numba functions (optional, reduces first-run time)
if python -c "from moderation import IndShockMoMConsumerType; print('‚úì Numba JIT compiled')" 2>&1; then
    : # Success message printed by Python
else
    echo "‚ö†Ô∏è Numba warmup skipped (first run may be slower)"
fi

# ============================================================================
# Verify installation
# ============================================================================
echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "‚úÖ Binder environment ready!"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo "   Python:  $(python --version)"
echo "   Node.js: $(node --version)"
myst_version=$(myst --version 2>&1) && echo "   MyST:    $myst_version" || echo "   MyST:    not available"
echo ""

# List key packages (show warning if imports fail - these are critical)
if ! python -c "
import HARK; print(f'   HARK:    {HARK.__version__}')
import numpy; print(f'   NumPy:   {numpy.__version__}')
import scipy; print(f'   SciPy:   {scipy.__version__}')
import matplotlib; print(f'   Matplotlib: {matplotlib.__version__}')
" 2>&1; then
    echo "   ‚ö†Ô∏è WARNING: Some packages failed to import - check installation"
fi

echo ""

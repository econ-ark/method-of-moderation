#!/bin/bash
#
# Method of Moderation Reproduction Benchmarking Wrapper
#
# This script wraps reproduce.sh or reproduce_min.sh to capture detailed timing
# and system information for benchmarking purposes.
#
# Usage:
#   ./README_IF_YOU_ARE_AN_AI/benchmarks/benchmark.sh           # Benchmark full reproduction
#   ./README_IF_YOU_ARE_AN_AI/benchmarks/benchmark.sh --min     # Benchmark minimal reproduction
#   ./README_IF_YOU_ARE_AN_AI/benchmarks/benchmark.sh --min --notes "Testing M1 Mac"

set -euo pipefail

# Get absolute paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
RESULTS_DIR="$SCRIPT_DIR/results/autogenerated"
CAPTURE_SCRIPT="$SCRIPT_DIR/capture_system_info.py"
REPRODUCE_SCRIPT="$PROJECT_ROOT/reproduce.sh"
REPRODUCE_MIN_SCRIPT="$PROJECT_ROOT/reproduce_min.sh"

# Ensure results directory exists
mkdir -p "$RESULTS_DIR"

# Parse arguments
USE_MIN=false
BENCHMARK_NOTES=""
while [[ $# -gt 0 ]]; do
    case $1 in
        --min|--minimal)
            USE_MIN=true
            shift
            ;;
        --notes)
            BENCHMARK_NOTES="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--min] [--notes "note"]"
            exit 1
            ;;
    esac
done

# Determine reproduction script and mode
if [[ "$USE_MIN" == "true" ]]; then
    REPRODUCE_SCRIPT="$REPRODUCE_MIN_SCRIPT"
    REPRODUCTION_MODE="min"
else
    REPRODUCTION_MODE="full"
fi

# Generate benchmark ID
TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)
BENCHMARK_ID="${TIMESTAMP}_${REPRODUCTION_MODE}_${OS}-${ARCH}"
OUTPUT_FILE="$RESULTS_DIR/${BENCHMARK_ID}.json"

echo "========================================"
echo "Method of Moderation Reproduction Benchmark"
echo "========================================"
echo ""
echo "Benchmark ID: $BENCHMARK_ID"
echo "Mode: $REPRODUCTION_MODE"
echo "Output: $OUTPUT_FILE"
if [[ -n "$BENCHMARK_NOTES" ]]; then
    echo "Notes: $BENCHMARK_NOTES"
fi
echo ""
echo "Capturing system information..."

# Capture system info
python3 "$CAPTURE_SCRIPT" --output /tmp/moderation_sysinfo_$$.json --pretty

echo "Starting reproduction..."
echo "========================================"
echo ""

# Record start time
START_TIME=$(date +%s)
START_ISO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# Run reproduction and capture exit status
EXIT_STATUS=0
"$REPRODUCE_SCRIPT" || EXIT_STATUS=$?

# Record end time
END_TIME=$(date +%s)
END_ISO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
DURATION=$((END_TIME - START_TIME))

echo ""
echo "========================================"
echo "Reproduction completed"
echo "========================================"
echo ""
echo "Duration: ${DURATION}s ($(printf '%d:%02d:%02d' $((DURATION/3600)) $((DURATION%3600/60)) $((DURATION%60))))"
echo "Exit status: $EXIT_STATUS"
echo ""

# Build final JSON using Python
echo "Generating benchmark report..."

# Set username (handle unset variable with set -u)
USER_NAME="${USER:-${USERNAME:-unknown}}"

python3 << PYEOF > "$OUTPUT_FILE"
import json
import os
import sys

# Read system info
with open("/tmp/moderation_sysinfo_$$.json") as f:
    system_info = json.load(f)

# Build benchmark JSON
benchmark = {
    "benchmark_version": "1.0.0",
    "benchmark_id": "$BENCHMARK_ID",
    "timestamp": "$START_ISO",
    "timestamp_end": "$END_ISO",
    "reproduction_mode": "$REPRODUCTION_MODE",
    "exit_status": $EXIT_STATUS,
    "duration_seconds": $DURATION,
    "system": system_info["system"],
    "environment": system_info["environment"],
    "git": system_info["git"],
    "metadata": {
        "user": "$USER_NAME",
        "session_id": "$$",
        "ci": os.environ.get("CI", "false").lower() == "true",
        "notes": "$BENCHMARK_NOTES"
    }
}

print(json.dumps(benchmark, indent=2))
PYEOF

# Clean up temp file
rm -f /tmp/moderation_sysinfo_$$.json

echo "‚úÖ Benchmark report saved: $OUTPUT_FILE"
echo ""

# Create/update latest symlink
ln -sf "$BENCHMARK_ID.json" "$RESULTS_DIR/latest.json"
echo "üìä Latest benchmark: $RESULTS_DIR/latest.json"
echo ""

# Display summary
echo "========================================"
echo "Benchmark Summary"
echo "========================================"
echo ""
echo "Mode:     $REPRODUCTION_MODE"
echo "Duration: $(printf '%d:%02d:%02d' $((DURATION/3600)) $((DURATION%3600/60)) $((DURATION%60))) ($DURATION seconds)"
if [ $EXIT_STATUS -eq 0 ]; then
    echo "Status:   ‚úÖ Success"
else
    echo "Status:   ‚ùå Failed (exit $EXIT_STATUS)"
fi
echo "OS:       $(uname -s) $(uname -r)"
echo "Arch:     $(uname -m)"
echo ""
echo "View full report:"
echo "  cat $OUTPUT_FILE | jq ."
echo ""
echo "View system info:"
echo "  cat $OUTPUT_FILE | jq '.system'"
echo ""

exit $EXIT_STATUS
